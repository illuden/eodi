<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tax Refund Calculator (Global Only)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fff; color:#111; max-width:520px; margin:0 auto; padding:20px; }
    h3 { text-align:center; margin:0 0 8px; }
    p { text-align:center; margin:0 0 18px; color:#666; font-size:14px; }
    label { display:block; font-size:14px; margin-bottom:6px; }
    input, button { font-size:16px; padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; box-sizing:border-box; }
    input { width:100%; margin-bottom:10px; }
    .button-group { display:flex; gap:10px; margin-bottom:14px; }
    .button-group button { flex:1; cursor:pointer; }
    #alvin-result { font-size:15px; line-height:1.7; border-top:1px dashed #e5e7eb; padding-top:14px; }
    .footer { font-size:12px; color:#777; text-align:center; margin-top:18px; }
  </style>
</head>
<body>
  <h3>🧾 Tax Refund Calculator</h3>
  <p>Global Tax Free 기준 환급액과 최종 결제 금액</p>

  <label for="alvin-input">💳 Purchase Amount (₩)</label>
  <input type="text" id="alvin-input" inputmode="numeric" placeholder="예: 150,000" />

  <div class="button-group">
    <button id="alvin-check">Check</button>
    <button id="alvin-reset" aria-label="Reset input and result">Reset</button>
  </div>

  <div id="alvin-result" aria-live="polite"></div>

  <div class="footer">
    * 참고용 결과이며, 실제 환급액은 업체 사정에 따라 일부 차이가 있을 수 있습니다.<br/>
    © 2025 <strong>Alvin Travel</strong>. All rights reserved.
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    // ---- Global Tax Free 환급표 (all 값만 사용) ----
    const table = [
      { min: 15000, max: 29999, all: 0 }, // Global 데이터 없음 → 0 처리
      { min: 30000, max: 49999, all: 2000 },
      { min: 50000, max: 74999, all: 3000 },
      { min: 75000, max: 99999, all: 5000 },
      { min: 100000, max: 124999, all: 6000 },
      { min: 125000, max: 149999, all: 8000 },
      { min: 150000, max: 174999, all: 9000 },
      { min: 175000, max: 199999, all: 10000 },
      { min: 200000, max: 224999, all: 12000 },
      { min: 225000, max: 249999, all: 13000 },
      { min: 250000, max: 274999, all: 15000 },
      { min: 275000, max: 299999, all: 17000 },
      { min: 300000, max: 324999, all: 19000 },
      { min: 325000, max: 349999, all: 21000 },
      { min: 350000, max: 374999, all: 23000 },
      { min: 375000, max: 399999, all: 25000 },
      { min: 400000, max: 424999, all: 27000 },
      { min: 425000, max: 449999, all: 28000 },
      { min: 450000, max: 474999, all: 30000 },
      { min: 475000, max: 499999, all: 32000 },
      { min: 500000, max: 549999, all: 35000 },
      { min: 550000, max: 599999, all: 37000 },
      { min: 600000, max: 649999, all: 41000 },
      { min: 650000, max: 699999, all: 45000 },
      { min: 700000, max: 749999, all: 50000 },
      { min: 750000, max: 799999, all: 53000 },
      { min: 800000, max: 849999, all: 57000 },
      { min: 850000, max: 899999, all: 60000 },
      { min: 900000, max: 949999, all: 65000 },
      { min: 950000, max: 999999, all: 68000 },
      { min: 1000000, max: 1099999, all: 74000 },
      { min: 1100000, max: 1199999, all: 80000 },
      { min: 1200000, max: 1299999, all: 90000 },
      { min: 1300000, max: 1399999, all: 95000 },
      { min: 1400000, max: 1499999, all: 104000 },
      { min: 1500000, max: 1599999, all: 110000 },
      { min: 1600000, max: 1699999, all: 115000 },
      { min: 1700000, max: 1799999, all: 127000 },
      { min: 1800000, max: 1899999, all: 135000 },
      { min: 1900000, max: 1999999, all: 140000 },
      { min: 2000000, max: 2099999, all: 150000 },
      { min: 2100000, max: 2199999, all: 155000 },
      { min: 2200000, max: 2299999, all: 160000 },
      { min: 2300000, max: 2399999, all: 170000 },
      { min: 2400000, max: 2499999, all: 177000 },
      { min: 2500000, max: 2599999, all: 185000 },
      { min: 2600000, max: 2699999, all: 190000 },
      { min: 2700000, max: 2799999, all: 200000 },
      { min: 2800000, max: 2899999, all: 210000 },
      { min: 2900000, max: 2999999, all: 215000 },
      { min: 3000000, max: 3099999, all: 225000 },
      { min: 3100000, max: 3199999, all: 230000 },
      { min: 3200000, max: 3299999, all: 235000 },
      { min: 3300000, max: 3399999, all: 240000 },
      { min: 3400000, max: 3499999, all: 250000 },
      { min: 3500000, max: 3599999, all: 260000 },
      { min: 3600000, max: 3699999, all: 270000 },
      { min: 3700000, max: 3799999, all: 280000 },
      { min: 3800000, max: 3899999, all: 285000 },
      { min: 3900000, max: 3999999, all: 290000 },
      { min: 4000000, max: 4099999, all: 300000 },
      { min: 4100000, max: 4199999, all: 310000 },
      { min: 4200000, max: 4299999, all: 315000 },
      { min: 4300000, max: 4399999, all: 320000 },
      { min: 4400000, max: 4499999, all: 333000 },
      { min: 4500000, max: 4599999, all: 340000 },
      { min: 4600000, max: 4699999, all: 350000 },
      { min: 4700000, max: 4799999, all: 360000 },
      { min: 4800000, max: 4899999, all: 370000 },
      { min: 4900000, max: 4999999, all: 380000 },
      { min: 5000000, max: 5099999, all: 390000 },
      { min: 5100000, max: 5199999, all: 400000 },
      { min: 5200000, max: 5299999, all: 410000 },
      { min: 5300000, max: 5399999, all: 420000 },
      { min: 5400000, max: 5499999, all: 430000 },
      { min: 5500000, max: 5599999, all: 440000 },
      { min: 5600000, max: 5699999, all: 450000 },
      { min: 5700000, max: 5799999, all: 460000 },
      { min: 5800000, max: 5899999, all: 470000 },
      { min: 5900000, max: 5999999, all: 480000 }
    ];

    const input = document.getElementById("alvin-input");
    const result = document.getElementById("alvin-result");
    const check = document.getElementById("alvin-check");
    const reset = document.getElementById("alvin-reset");

    const formatKRW = (n) => n.toLocaleString("ko-KR") + " KRW";
    const parseNumber = (str) => Number(String(str).replace(/[^\d]/g, "") || 0);

    function findRefund(amount) {
      if (amount < 15000) return 0;
      if (amount >= 6000000) {
        // 6,000,000원 이상: 기존 로직 유지 (1,000원 단위 내림)
        const est = Math.floor((amount * 0.0818) / 1000) * 1000;
        return est > 0 ? est : 0;
      }
      for (let row of table) {
        if (amount >= row.min && amount <= row.max) {
          return row.all ?? 0;
        }
      }
      return 0; // 테이블 범위 외: 0 처리
    }

    function render() {
      const amount = parseNumber(input.value);
      if (!amount) {
        result.innerHTML = `<span style="color:#ef4444">⚠️ 올바른 금액을 입력하세요.</span>`;
        return;
      }
      const refund = findRefund(amount);
      const finalPrice = Math.max(amount - refund, 0);

      result.innerHTML = `
        <div><strong>Tax Free:</strong> ${formatKRW(refund)}</div>
        <div><strong>Final Price:</strong> ${formatKRW(finalPrice)}</div>
      `;
    }

    // 입력값을 천단위 쉼표로 표시
    input.addEventListener("input", () => {
      const caretEnd = input.selectionEnd;
      const raw = parseNumber(input.value);
      input.value = raw ? raw.toLocaleString("ko-KR") : "";
      input.setSelectionRange(input.value.length, input.value.length);
    });

    check.addEventListener("click", render);
    input.addEventListener("keydown", (e) => { if (e.key === "Enter") render(); });

    reset.addEventListener("click", function () {
      input.value = "";
      result.innerHTML = "";
      input.focus();
    });
  });

  // iframe 높이 전달(필요 시 유지)
  function sendHeightToParent() {
    const height = document.body.scrollHeight;
    parent.postMessage({ type: "resize", height }, "*");
  }
  window.addEventListener("load", sendHeightToParent);
  window.addEventListener("resize", sendHeightToParent);
  </script>
</body>
</html>
